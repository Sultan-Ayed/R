import { useState, useEffect, useCallback } from "react";

const LEVELS = {
  A1: { name: "Beginner",          color: "#6db87a", prompt: "Write 2–3 simple sentences. What do you see in the image?",                              minWords: 8  },
  A2: { name: "Elementary",        color: "#5aabcc", prompt: "Write 3–5 sentences. Describe the people, place, or objects you see.",                   minWords: 20 },
  B1: { name: "Intermediate",      color: "#c9a84c", prompt: "Write a short paragraph (5–8 sentences). What is happening and where?",                  minWords: 45 },
  B2: { name: "Upper-Intermediate",color: "#d4845a", prompt: "Write 2 paragraphs: describe the scene, then share your thoughts about it.",             minWords: 75 },
  C1: { name: "Advanced",          color: "#a06fbd", prompt: "Write 2–3 detailed paragraphs. Describe vividly, analyze the mood, and tell the story.", minWords: 110 },
  C2: { name: "Mastery",           color: "#c0512f", prompt: "Write an expressive piece. Use rich vocabulary, varied structures, and explore deeper meaning.", minWords: 160 },
};

const IMAGE_IDS = [10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,210,220,230,240,250,260,270,280,290,300,310,320,330,340,350,360,370,380,390,400,410,420,430,440,450,460,470,480,490,500];

function Spinner() {
  return (
    <div style={{ display:"flex", flexDirection:"column", alignItems:"center", gap:"1rem", padding:"4rem 0" }}>
      <div style={{
        width:40, height:40,
        border:"3px solid #e8e0d0",
        borderTopColor:"#c9a84c",
        borderRadius:"50%",
        animation:"spin 0.8s linear infinite"
      }}/>
      <p style={{ color:"#8a7f70", fontFamily:"Georgia,serif", fontSize:"1rem" }}>Analyzing your writing…</p>
      <style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style>
    </div>
  );
}

function ScoreRing({ score }) {
  const r = 36, circ = 2 * Math.PI * r;
  const dash = circ * (score / 100);
  const color = score >= 85 ? "#4a7c6f" : score >= 65 ? "#c9a84c" : "#c0512f";
  return (
    <div style={{ position:"relative", width:90, height:90 }}>
      <svg width="90" height="90" style={{ transform:"rotate(-90deg)" }}>
        <circle cx="45" cy="45" r={r} fill="none" stroke="#ede8db" strokeWidth="6"/>
        <circle cx="45" cy="45" r={r} fill="none" stroke={color} strokeWidth="6"
          strokeDasharray={`${dash} ${circ}`} strokeLinecap="round"
          style={{ transition:"stroke-dasharray 1s ease" }}/>
      </svg>
      <div style={{ position:"absolute", inset:0, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center" }}>
        <span style={{ fontFamily:"Georgia,serif", fontSize:"1.6rem", fontWeight:900, color, lineHeight:1 }}>{score}</span>
        <span style={{ fontSize:"0.65rem", color:"#8a7f70" }}>/ 100</span>
      </div>
    </div>
  );
}

export default function WriteUp() {
  const [screen, setScreen] = useState("level"); // level | practice | loading | correction
  const [level, setLevel] = useState(null);
  const [imgId, setImgId] = useState(() => IMAGE_IDS[Math.floor(Math.random() * IMAGE_IDS.length)]);
  const [imgLoaded, setImgLoaded] = useState(false);
  const [text, setText] = useState("");
  const [feedback, setFeedback] = useState(null);
  const [error, setError] = useState(null);

  const randomImg = () => {
    setImgLoaded(false);
    const newId = IMAGE_IDS[Math.floor(Math.random() * IMAGE_IDS.length)];
    setImgId(newId);
  };

  const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;

  // ── AI Correction
  const checkWriting = async () => {
    if (wordCount < 3) return;
    setScreen("loading");
    setError(null);
    try {
      const levelDescriptions = {
        A1: "beginner A1 – very basic vocabulary, simple present tense",
        A2: "elementary A2 – basic sentences on familiar topics",
        B1: "intermediate B1 – can handle familiar topics with some errors expected",
        B2: "upper-intermediate B2 – fairly complex writing expected",
        C1: "advanced C1 – sophisticated vocabulary and complex structures expected",
        C2: "mastery C2 – near-native fluency expected",
      };

      const res = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          system: "You are an expert English writing teacher. Always respond with valid JSON only — no markdown, no extra text.",
          messages: [{
            role: "user",
            content: `A student at level ${levelDescriptions[level]} wrote this English text to describe an image:\n\n"${text}"\n\nReturn a JSON object with EXACTLY this structure:\n{\n  "score": <0-100>,\n  "spellingErrors": [{ "wrong": "...", "correct": "...", "explanation": "..." }],\n  "grammarErrors": [{ "wrong": "...", "correct": "...", "explanation": "..." }],\n  "styleAdvice": [{ "issue": "...", "suggestion": "..." }],\n  "rewrite": "Corrected and improved version at their level",\n  "encouragement": "1-2 sentence motivating message"\n}\nRules: use [] for empty arrays. Score: 90-100=excellent, 75-89=good, 60-74=fair, <60=needs work.`
          }]
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error?.message || "API Error");
      const raw = data.content.map(b => b.text || "").join("").replace(/```json|```/g, "").trim();
      setFeedback(JSON.parse(raw));
      setScreen("correction");
    } catch (e) {
      setError(e.message);
      setScreen("practice");
    }
  };

  // ── SCREEN: Level Selection
  if (screen === "level") return (
    <div style={{ minHeight:"100vh", background:"#f5f0e8", fontFamily:"'DM Sans',system-ui,sans-serif" }}>
      <header style={{ padding:"1.5rem 3rem", borderBottom:"1px solid rgba(0,0,0,0.1)", display:"flex", alignItems:"center", justifyContent:"space-between" }}>
        <div style={{ fontFamily:"Georgia,serif", fontSize:"1.8rem", fontWeight:900, letterSpacing:"-0.03em" }}>
          Write<span style={{ color:"#c9a84c" }}>Up</span>
        </div>
        <div style={{ fontSize:"0.72rem", letterSpacing:"0.15em", textTransform:"uppercase", color:"#8a7f70" }}>English Writing Practice</div>
      </header>

      <main style={{ maxWidth:800, margin:"0 auto", padding:"3rem 1.5rem" }}>
        <div style={{ textAlign:"center", marginBottom:"3rem" }}>
          <h1 style={{ fontFamily:"Georgia,serif", fontSize:"clamp(2rem,5vw,3.2rem)", fontWeight:900, lineHeight:1.1, marginBottom:"0.8rem" }}>
            Choose Your<br/>Writing Level
          </h1>
          <p style={{ color:"#8a7f70", fontSize:"1rem", lineHeight:1.7 }}>
            Pick your level, describe a random image, and get instant AI feedback on your English writing.
          </p>
        </div>

        <div style={{ display:"grid", gridTemplateColumns:"repeat(auto-fill,minmax(220px,1fr))", gap:"1rem", marginBottom:"2.5rem" }}>
          {Object.entries(LEVELS).map(([key, cfg]) => (
            <div key={key} onClick={() => setLevel(key)}
              style={{
                background: level === key ? "#fffdf5" : "white",
                border: `2px solid ${level === key ? cfg.color : "rgba(0,0,0,0.1)"}`,
                borderRadius:6, padding:"1.5rem", cursor:"pointer",
                transition:"all 0.2s",
                boxShadow: level === key ? `0 4px 20px ${cfg.color}33` : "none",
                transform: level === key ? "translateY(-2px)" : "none",
                position:"relative", overflow:"hidden"
              }}>
              {level === key && <div style={{ position:"absolute", bottom:0, left:0, right:0, height:3, background:cfg.color }}/>}
              <div style={{ fontFamily:"Georgia,serif", fontSize:"2rem", fontWeight:900, color:cfg.color, lineHeight:1 }}>{key}</div>
              <div style={{ fontSize:"0.72rem", letterSpacing:"0.1em", textTransform:"uppercase", fontWeight:600, margin:"0.4rem 0" }}>{cfg.name}</div>
              <div style={{ fontSize:"0.8rem", color:"#8a7f70", lineHeight:1.5 }}>{cfg.prompt.slice(0, 60)}…</div>
            </div>
          ))}
        </div>

        <div style={{ textAlign:"center" }}>
          <button onClick={() => { if(level) { randomImg(); setScreen("practice"); } }}
            disabled={!level}
            style={{
              padding:"0.9rem 3rem", background: level ? "#0a0a0f" : "#ccc",
              color: level ? "#f5f0e8" : "#888", border:"none", borderRadius:4,
              fontFamily:"inherit", fontSize:"1rem", fontWeight:500,
              cursor: level ? "pointer" : "not-allowed", letterSpacing:"0.04em",
              transition:"background 0.2s"
            }}>
            Start Writing Practice →
          </button>
        </div>
      </main>
    </div>
  );

  // ── SCREEN: Loading
  if (screen === "loading") return (
    <div style={{ minHeight:"100vh", background:"#f5f0e8", display:"flex", alignItems:"center", justifyContent:"center" }}>
      <Spinner/>
    </div>
  );

  // ── SCREEN: Practice
  if (screen === "practice") {
    const cfg = LEVELS[level];
    return (
      <div style={{ minHeight:"100vh", background:"#f5f0e8", fontFamily:"'DM Sans',system-ui,sans-serif" }}>
        <header style={{ padding:"1.2rem 2rem", borderBottom:"1px solid rgba(0,0,0,0.1)", display:"flex", alignItems:"center", gap:"1rem" }}>
          <button onClick={() => setScreen("level")}
            style={{ background:"none", border:"1.5px solid rgba(0,0,0,0.15)", borderRadius:4, padding:"0.4rem 0.9rem", fontFamily:"inherit", fontSize:"0.85rem", cursor:"pointer" }}>
            ← Back
          </button>
          <div style={{ fontFamily:"Georgia,serif", fontSize:"Georgia,serif", fontWeight:700, color:cfg.color, background:"#fffdf5", border:`1.5px solid ${cfg.color}`, borderRadius:4, padding:"0.25rem 0.8rem", fontSize:"1rem" }}>
            {level} · {cfg.name}
          </div>
        </header>

        <main style={{ maxWidth:860, margin:"0 auto", padding:"2rem 1.5rem" }}>
          {error && (
            <div style={{ background:"#fce4d6", border:"1.5px solid #c0512f", borderRadius:4, padding:"0.8rem 1.2rem", marginBottom:"1rem", color:"#c0512f", fontSize:"0.88rem" }}>
              ⚠ {error}
            </div>
          )}

          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:"2rem" }}>
            {/* Image */}
            <div>
              <div style={{ borderRadius:6, overflow:"hidden", border:"1.5px solid rgba(0,0,0,0.1)", background:"#ede8db", aspectRatio:"4/3", position:"relative" }}>
                {!imgLoaded && (
                  <div style={{ position:"absolute", inset:0, display:"flex", alignItems:"center", justifyContent:"center", color:"#8a7f70", fontSize:"0.85rem" }}>
                    Loading…
                  </div>
                )}
                <img
                  src={`https://picsum.photos/id/${imgId}/600/450`}
                  alt="Describe this"
                  onLoad={() => setImgLoaded(true)}
                  onError={() => { setImgId(IMAGE_IDS[Math.floor(Math.random()*IMAGE_IDS.length)]); }}
                  style={{ width:"100%", height:"100%", objectFit:"cover", opacity: imgLoaded ? 1 : 0, transition:"opacity 0.4s" }}
                />
              </div>
              <button onClick={randomImg}
                style={{ marginTop:"0.7rem", width:"100%", background:"none", border:"1.5px solid rgba(0,0,0,0.12)", borderRadius:4, padding:"0.5rem", fontFamily:"inherit", fontSize:"0.82rem", color:"#8a7f70", cursor:"pointer" }}>
                ↻ New Image
              </button>
            </div>

            {/* Writing */}
            <div style={{ display:"flex", flexDirection:"column" }}>
              <div style={{ fontSize:"0.72rem", letterSpacing:"0.1em", textTransform:"uppercase", fontWeight:500, color:"#8a7f70", marginBottom:"0.5rem" }}>Your Task</div>
              <div style={{ background:"#ede8db", borderLeft:`3px solid ${cfg.color}`, borderRadius:"0 4px 4px 0", padding:"0.8rem 1rem", marginBottom:"1rem", fontSize:"0.88rem", color:"#4a4540", lineHeight:1.6 }}>
                {cfg.prompt}
              </div>
              <textarea
                value={text}
                onChange={e => setText(e.target.value)}
                placeholder="Write your description here…"
                style={{
                  flex:1, minHeight:180, padding:"1rem", border:"1.5px solid rgba(0,0,0,0.12)",
                  borderRadius:4, fontFamily:"inherit", fontSize:"0.95rem", lineHeight:1.7,
                  color:"#0a0a0f", background:"white", resize:"vertical", outline:"none"
                }}
              />
              <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginTop:"0.4rem", marginBottom:"1rem" }}>
                <span style={{ fontSize:"0.78rem", color: wordCount < cfg.minWords ? "#c0512f" : "#4a7c6f" }}>
                  {wordCount} words {wordCount < cfg.minWords ? `(need ${cfg.minWords}+)` : "✓"}
                </span>
              </div>
              <button onClick={checkWriting} disabled={wordCount < 3}
                style={{
                  padding:"0.9rem", background: wordCount >= 3 ? "#4a7c6f" : "#ccc",
                  color:"white", border:"none", borderRadius:4,
                  fontFamily:"inherit", fontSize:"0.98rem", fontWeight:500,
                  cursor: wordCount >= 3 ? "pointer" : "not-allowed", transition:"background 0.2s"
                }}>
                ✓ Check My Writing
              </button>
            </div>
          </div>
        </main>
      </div>
    );
  }

  // ── SCREEN: Correction
  if (screen === "correction" && feedback) {
    const cfg = LEVELS[level];
    const Card = ({ icon, iconBg, iconColor, title, count, children }) => (
      <div style={{ background:"white", border:"1.5px solid rgba(0,0,0,0.1)", borderRadius:6, overflow:"hidden", marginBottom:"1.2rem" }}>
        <div style={{ display:"flex", alignItems:"center", gap:"0.8rem", padding:"0.9rem 1.3rem", background:"#f5f0e8", borderBottom:"1.5px solid rgba(0,0,0,0.08)" }}>
          <div style={{ width:28, height:28, borderRadius:"50%", background:iconBg, color:iconColor, display:"flex", alignItems:"center", justifyContent:"center", fontSize:"0.9rem", fontWeight:700 }}>{icon}</div>
          <div style={{ fontWeight:600, fontSize:"0.95rem" }}>{title}</div>
          {count > 0 && <span style={{ marginLeft:"auto", background:iconBg, color:iconColor, fontSize:"0.72rem", fontWeight:700, padding:"0.15rem 0.6rem", borderRadius:20 }}>{count} issue{count>1?"s":""}</span>}
        </div>
        <div style={{ padding:"1.1rem 1.3rem" }}>{children}</div>
      </div>
    );

    const NoErrors = ({ label }) => (
      <div style={{ color:"#4a7c6f", fontWeight:500, fontSize:"0.88rem" }}>✓ No {label} errors — great job!</div>
    );

    const ErrorList = ({ items, dotColor, isStyle }) => (
      <ul style={{ listStyle:"none", display:"flex", flexDirection:"column", gap:"0.8rem" }}>
        {items.map((item, i) => (
          <li key={i} style={{ display:"grid", gridTemplateColumns:"10px 1fr", gap:"0.7rem", fontSize:"0.88rem", lineHeight:1.6 }}>
            <span style={{ width:8, height:8, borderRadius:"50%", background:dotColor, marginTop:"0.45rem", display:"block" }}/>
            <div>
              {isStyle ? (
                <><span style={{ fontWeight:500 }}>{item.issue}</span><br/><span style={{ color:"#8a7f70" }}>{item.suggestion}</span></>
              ) : (
                <><span style={{ color:"#c0512f", textDecoration:"line-through", fontWeight:500 }}>{item.wrong}</span>
                {" → "}<span style={{ color:"#4a7c6f", fontWeight:600 }}>{item.correct}</span>
                <br/><span style={{ color:"#8a7f70" }}>{item.explanation}</span></>
              )}
            </div>
          </li>
        ))}
      </ul>
    );

    return (
      <div style={{ minHeight:"100vh", background:"#f5f0e8", fontFamily:"'DM Sans',system-ui,sans-serif" }}>
        <header style={{ padding:"1.2rem 2rem", borderBottom:"1px solid rgba(0,0,0,0.1)", display:"flex", alignItems:"center", gap:"1rem" }}>
          <button onClick={() => setScreen("practice")}
            style={{ background:"none", border:"1.5px solid rgba(0,0,0,0.15)", borderRadius:4, padding:"0.4rem 0.9rem", fontFamily:"inherit", fontSize:"0.85rem", cursor:"pointer" }}>
            ← Back
          </button>
          <div style={{ fontFamily:"Georgia,serif", fontWeight:700, color:cfg.color, background:"#fffdf5", border:`1.5px solid ${cfg.color}`, borderRadius:4, padding:"0.25rem 0.8rem", fontSize:"1rem" }}>
            {level} · {cfg.name}
          </div>
        </header>

        <main style={{ maxWidth:760, margin:"0 auto", padding:"2rem 1.5rem 4rem" }}>
          {/* Header */}
          <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:"2rem", flexWrap:"wrap", gap:"1rem" }}>
            <div>
              <h2 style={{ fontFamily:"Georgia,serif", fontSize:"2rem", fontWeight:900 }}>Writing Feedback</h2>
              <p style={{ color:"#8a7f70", fontSize:"0.88rem", marginTop:"0.2rem" }}>{feedback.encouragement}</p>
            </div>
            <ScoreRing score={feedback.score}/>
          </div>

          {/* Original */}
          <div style={{ background:"#ede8db", borderLeft:"3px solid rgba(0,0,0,0.15)", borderRadius:"0 4px 4px 0", padding:"1rem 1.3rem", marginBottom:"2rem" }}>
            <div style={{ fontSize:"0.72rem", letterSpacing:"0.1em", textTransform:"uppercase", color:"#8a7f70", fontWeight:500, marginBottom:"0.5rem" }}>Your Writing</div>
            <p style={{ fontSize:"0.92rem", lineHeight:1.8, color:"#0a0a0f" }}>{text}</p>
          </div>

          {/* Cards */}
          <Card icon="✎" iconBg="#fce4d6" iconColor="#c0512f" title="Spelling" count={feedback.spellingErrors?.length || 0}>
            {!feedback.spellingErrors?.length ? <NoErrors label="spelling"/> : <ErrorList items={feedback.spellingErrors} dotColor="#c0512f"/>}
          </Card>

          <Card icon="⚙" iconBg="#d6e8f5" iconColor="#2a6fa8" title="Grammar" count={feedback.grammarErrors?.length || 0}>
            {!feedback.grammarErrors?.length ? <NoErrors label="grammar"/> : <ErrorList items={feedback.grammarErrors} dotColor="#2a6fa8"/>}
          </Card>

          <Card icon="✦" iconBg="#d6f0e8" iconColor="#4a7c6f" title="Writing Style" count={feedback.styleAdvice?.length || 0}>
            {!feedback.styleAdvice?.length ? <NoErrors label="style"/> : <ErrorList items={feedback.styleAdvice} dotColor="#4a7c6f" isStyle/>}
          </Card>

          <Card icon="✐" iconBg="#f5f0d6" iconColor="#8a7a2a" title="Suggested Rewrite">
            <p style={{ fontSize:"0.78rem", color:"#8a7f70", marginBottom:"0.7rem" }}>Here's an improved version while keeping your ideas:</p>
            <div style={{ background:"#fffdf5", border:"1px dashed #c9a84c", borderRadius:4, padding:"1rem 1.2rem", fontSize:"0.95rem", lineHeight:1.9, color:"#0a0a0f" }}>
              {feedback.rewrite}
            </div>
          </Card>

          {/* Actions */}
          <div style={{ display:"flex", gap:"1rem", marginTop:"1.5rem" }}>
            <button onClick={() => { setText(""); setScreen("practice"); }}
              style={{ flex:1, padding:"0.9rem", background:"#0a0a0f", color:"#f5f0e8", border:"none", borderRadius:4, fontFamily:"inherit", fontSize:"0.95rem", fontWeight:500, cursor:"pointer" }}>
              Try Same Image Again
            </button>
            <button onClick={() => { setText(""); randomImg(); setScreen("practice"); }}
              style={{ flex:1, padding:"0.9rem", background:"white", color:"#0a0a0f", border:"1.5px solid rgba(0,0,0,0.15)", borderRadius:4, fontFamily:"inherit", fontSize:"0.95rem", fontWeight:500, cursor:"pointer" }}>
              New Image →
            </button>
          </div>
        </main>
      </div>
    );
  }

  return null;
}
