<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WriteUp — English Writing Practice</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#f5f0e8;font-family:'DM Sans',system-ui,sans-serif;color:#0a0a0f}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes dash{from{stroke-dasharray:0 999}to{stroke-dasharray:var(--target) 999}}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#ede8db}
::-webkit-scrollbar-thumb{background:#c9a84c;border-radius:3px}
textarea:focus,input:focus{outline:none}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;

/* ── Config ─────────────────────────────────────────── */
const LEVELS = {
  A1:{ label:"Beginner",           color:"#5aab6e", min:8,   prompt:"Write 2–3 simple sentences. What do you see in the image?" },
  A2:{ label:"Elementary",         color:"#3d9dbf", min:20,  prompt:"Write 3–5 sentences. Describe the people, place, or objects." },
  B1:{ label:"Intermediate",       color:"#c9a84c", min:45,  prompt:"Write a short paragraph (5–8 sentences). What is happening and where?" },
  B2:{ label:"Upper-Intermediate", color:"#d4845a", min:75,  prompt:"Write 2 paragraphs: describe the scene, then share your thoughts." },
  C1:{ label:"Advanced",           color:"#9b6dbd", min:110, prompt:"Write 2–3 detailed paragraphs. Describe vividly, analyze the mood, tell the story." },
  C2:{ label:"Mastery",            color:"#c0512f", min:160, prompt:"Write an expressive piece using rich vocabulary and complex structures." },
};

const IMGS = [10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,
              210,220,230,240,250,260,270,280,290,300,310,320,330,340,350,360,370,380,
              390,400,410,420,430,440,450,460,470,480,490,500,514,520,534,540,550,560];

const randImg = (exclude) => {
  let id; do { id = IMGS[Math.floor(Math.random()*IMGS.length)]; } while(id===exclude);
  return id;
};

/* ── Small components ───────────────────────────────── */
function Btn({children, onClick, disabled, variant="dark", style={}}){
  const base = {
    padding:"0.85rem 1.8rem", border:"none", borderRadius:5,
    fontFamily:"inherit", fontSize:"0.95rem", fontWeight:500,
    cursor: disabled ? "not-allowed" : "pointer",
    transition:"all 0.2s", letterSpacing:"0.02em",
    opacity: disabled ? 0.45 : 1, ...style
  };
  const themes = {
    dark:  { background:"#0a0a0f", color:"#f5f0e8" },
    green: { background:"#4a7c6f", color:"white" },
    ghost: { background:"white",   color:"#0a0a0f", border:"1.5px solid rgba(0,0,0,0.14)" },
    back:  { background:"none",    color:"#0a0a0f", border:"1.5px solid rgba(0,0,0,0.14)", padding:"0.45rem 1rem", fontSize:"0.85rem" },
  };
  return <button style={{...base,...themes[variant]}} onClick={disabled?undefined:onClick}>{children}</button>;
}

function Tag({level}){
  const c = LEVELS[level];
  return (
    <span style={{
      fontFamily:"'Playfair Display',serif", fontWeight:700,
      color:c.color, background:"#fffdf5",
      border:`1.5px solid ${c.color}`, borderRadius:4,
      padding:"0.2rem 0.75rem", fontSize:"0.95rem"
    }}>{level} · {c.label}</span>
  );
}

function ScoreRing({score}){
  const r=36, circ=2*Math.PI*r;
  const color = score>=85 ? "#4a7c6f" : score>=65 ? "#c9a84c" : "#c0512f";
  const dash = circ*(score/100);
  return (
    <div style={{position:"relative",width:90,height:90,flexShrink:0}}>
      <svg width="90" height="90" style={{transform:"rotate(-90deg)"}}>
        <circle cx="45" cy="45" r={r} fill="none" stroke="#ede8db" strokeWidth="6"/>
        <circle cx="45" cy="45" r={r} fill="none" stroke={color} strokeWidth="6"
          strokeDasharray={`${dash} ${circ}`} strokeLinecap="round"/>
      </svg>
      <div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
        <span style={{fontFamily:"'Playfair Display',serif",fontSize:"1.6rem",fontWeight:900,color,lineHeight:1}}>{score}</span>
        <span style={{fontSize:"0.62rem",color:"#8a7f70"}}>/ 100</span>
      </div>
    </div>
  );
}

function CorrCard({icon,bg,fg,title,badge,children}){
  return (
    <div style={{background:"white",border:"1.5px solid rgba(0,0,0,0.1)",borderRadius:6,overflow:"hidden",marginBottom:"1.1rem",animation:"fadeUp 0.4s ease both"}}>
      <div style={{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.85rem 1.3rem",background:"#f5f0e8",borderBottom:"1.5px solid rgba(0,0,0,0.08)"}}>
        <div style={{width:28,height:28,borderRadius:"50%",background:bg,color:fg,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.95rem",fontWeight:700,flexShrink:0}}>{icon}</div>
        <span style={{fontWeight:600,fontSize:"0.95rem"}}>{title}</span>
        {badge>0 && <span style={{marginLeft:"auto",background:bg,color:fg,fontSize:"0.72rem",fontWeight:700,padding:"0.15rem 0.65rem",borderRadius:20}}>{badge} issue{badge>1?"s":""}</span>}
      </div>
      <div style={{padding:"1.1rem 1.3rem"}}>{children}</div>
    </div>
  );
}

function NoErr({label}){ return <p style={{color:"#4a7c6f",fontWeight:500,fontSize:"0.88rem"}}>✓ No {label} errors — great job!</p>; }

function ErrList({items,dot,isStyle}){
  return (
    <ul style={{listStyle:"none",display:"flex",flexDirection:"column",gap:"0.9rem"}}>
      {items.map((it,i)=>(
        <li key={i} style={{display:"grid",gridTemplateColumns:"10px 1fr",gap:"0.75rem",fontSize:"0.88rem",lineHeight:1.65}}>
          <span style={{width:8,height:8,borderRadius:"50%",background:dot,marginTop:"0.5rem",display:"block",flexShrink:0}}/>
          {isStyle
            ? <div><strong>{it.issue}</strong><br/><span style={{color:"#8a7f70"}}>{it.suggestion}</span></div>
            : <div>
                <span style={{color:"#c0512f",textDecoration:"line-through",fontWeight:500}}>{it.wrong}</span>
                {" → "}<span style={{color:"#4a7c6f",fontWeight:600}}>{it.correct}</span>
                <br/><span style={{color:"#8a7f70"}}>{it.explanation}</span>
              </div>
          }
        </li>
      ))}
    </ul>
  );
}

/* ── API call ───────────────────────────────────────── */
async function getCorrection(text, level) {
  const descriptions = {
    A1:"beginner A1 – very basic vocabulary, simple present tense",
    A2:"elementary A2 – basic sentences on familiar topics",
    B1:"intermediate B1 – familiar topics, some errors expected",
    B2:"upper-intermediate B2 – fairly complex writing expected",
    C1:"advanced C1 – sophisticated vocabulary and complex structures expected",
    C2:"mastery C2 – near-native fluency expected",
  };

  const res = await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      model:"claude-sonnet-4-20250514",
      max_tokens:1000,
      system:"You are an expert English writing teacher. Always respond with valid JSON only — no markdown, no extra text.",
      messages:[{role:"user",content:
`A student at level ${descriptions[level]} wrote this English text to describe an image:\n\n"${text}"\n\nReturn a JSON object with EXACTLY this structure:\n{\n  "score": <0-100>,\n  "spellingErrors": [{"wrong":"...","correct":"...","explanation":"..."}],\n  "grammarErrors": [{"wrong":"...","correct":"...","explanation":"..."}],\n  "styleAdvice": [{"issue":"...","suggestion":"..."}],\n  "rewrite": "Corrected and improved version at their level",\n  "encouragement": "1-2 sentence motivating message"\n}\nUse [] for empty arrays. Score: 90-100=excellent,75-89=good,60-74=fair,<60=needs work.`
      }]
    })
  });

  const data = await res.json();
  if(!res.ok) throw new Error(data.error?.message || `Error ${res.status}`);
  const raw = data.content.map(b=>b.text||"").join("").replace(/```json|```/g,"").trim();
  return JSON.parse(raw);
}

/* ── Main App ───────────────────────────────────────── */
function App(){
  const [screen, setScreen]     = useState("level");
  const [level, setLevel]       = useState(null);
  const [imgId, setImgId]       = useState(()=>randImg(-1));
  const [imgOk, setImgOk]       = useState(false);
  const [text, setText]         = useState("");
  const [feedback, setFeedback] = useState(null);
  const [err, setErr]           = useState(null);
  const [loadMsg, setLoadMsg]   = useState("Analyzing your writing…");

  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  const cfg   = level ? LEVELS[level] : null;

  const newImg = ()=>{ setImgOk(false); setImgId(randImg(imgId)); };

  const submit = async ()=>{
    if(words<3) return;
    setScreen("loading"); setErr(null);
    const msgs = ["Analyzing your writing…","Checking grammar…","Looking for style tips…","Almost done…"];
    let i=0; const t=setInterval(()=>{ i=(i+1)%msgs.length; setLoadMsg(msgs[i]); },1400);
    try{
      const fb = await getCorrection(text, level);
      clearInterval(t); setFeedback(fb); setScreen("result");
    }catch(e){
      clearInterval(t); setErr(e.message); setScreen("practice");
    }
  };

  /* ── Level screen */
  if(screen==="level") return (
    <div style={{minHeight:"100vh",background:"#f5f0e8"}}>
      {/* header */}
      <header style={{padding:"1.4rem 3rem",borderBottom:"1px solid rgba(0,0,0,0.09)",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
        <div style={{fontFamily:"'Playfair Display',serif",fontSize:"1.85rem",fontWeight:900,letterSpacing:"-0.03em"}}>
          Write<span style={{color:"#c9a84c"}}>Up</span>
        </div>
        <span style={{fontSize:"0.72rem",letterSpacing:"0.15em",textTransform:"uppercase",color:"#8a7f70"}}>English Writing Practice</span>
      </header>

      <main style={{maxWidth:820,margin:"0 auto",padding:"3rem 1.5rem"}}>
        <div style={{textAlign:"center",marginBottom:"3rem",animation:"fadeUp 0.5s ease"}}>
          <h1 style={{fontFamily:"'Playfair Display',serif",fontSize:"clamp(2rem,5vw,3rem)",fontWeight:900,lineHeight:1.1,marginBottom:"0.8rem"}}>
            Choose Your<br/>Writing Level
          </h1>
          <p style={{color:"#8a7f70",fontSize:"1rem",lineHeight:1.75,maxWidth:460,margin:"0 auto"}}>
            Pick your level, describe a random image, and get instant AI feedback on your English writing.
          </p>
        </div>

        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(230px,1fr))",gap:"1rem",marginBottom:"2.5rem"}}>
          {Object.entries(LEVELS).map(([key,c])=>(
            <div key={key} onClick={()=>setLevel(key)} style={{
              background: level===key ? "#fffdf5" : "white",
              border:`2px solid ${level===key ? c.color : "rgba(0,0,0,0.1)"}`,
              borderRadius:6, padding:"1.5rem 1.3rem", cursor:"pointer",
              transition:"all 0.2s",
              boxShadow: level===key ? `0 6px 24px ${c.color}28` : "0 1px 4px rgba(0,0,0,0.05)",
              transform: level===key ? "translateY(-3px)" : "none",
              position:"relative", overflow:"hidden"
            }}>
              {level===key && <div style={{position:"absolute",bottom:0,left:0,right:0,height:3,background:c.color}}/>}
              <div style={{fontFamily:"'Playfair Display',serif",fontSize:"2.1rem",fontWeight:900,color:c.color,lineHeight:1}}>{key}</div>
              <div style={{fontSize:"0.72rem",letterSpacing:"0.1em",textTransform:"uppercase",fontWeight:600,margin:"0.4rem 0 0.5rem",color:"#0a0a0f"}}>{c.label}</div>
              <div style={{fontSize:"0.8rem",color:"#8a7f70",lineHeight:1.55}}>{c.prompt.slice(0,65)}…</div>
            </div>
          ))}
        </div>

        <div style={{textAlign:"center"}}>
          <Btn onClick={()=>{if(level){newImg();setScreen("practice");}}} disabled={!level} variant="dark">
            Start Writing Practice →
          </Btn>
        </div>
      </main>
    </div>
  );

  /* ── Loading screen */
  if(screen==="loading") return (
    <div style={{minHeight:"100vh",background:"#f5f0e8",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:"1.2rem"}}>
      <div style={{width:42,height:42,border:"3.5px solid #ede8db",borderTopColor:"#c9a84c",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}/>
      <p style={{fontFamily:"'Playfair Display',serif",fontSize:"1.05rem",color:"#8a7f70"}}>{loadMsg}</p>
    </div>
  );

  /* ── Practice screen */
  if(screen==="practice") return (
    <div style={{minHeight:"100vh",background:"#f5f0e8"}}>
      <header style={{padding:"1.1rem 2rem",borderBottom:"1px solid rgba(0,0,0,0.09)",display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"}}>
        <Btn variant="back" onClick={()=>setScreen("level")}>← Back</Btn>
        <Tag level={level}/>
      </header>

      <main style={{maxWidth:880,margin:"0 auto",padding:"2rem 1.5rem",animation:"fadeUp 0.4s ease"}}>
        {err && (
          <div style={{background:"#fce4d6",border:"1.5px solid #c0512f",borderRadius:5,padding:"0.8rem 1.2rem",marginBottom:"1.2rem",color:"#c0512f",fontSize:"0.88rem"}}>
            ⚠ {err}
          </div>
        )}

        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"2rem"}}>
          {/* Image col */}
          <div>
            <div style={{borderRadius:6,overflow:"hidden",border:"1.5px solid rgba(0,0,0,0.1)",background:"#ede8db",aspectRatio:"4/3",position:"relative"}}>
              {!imgOk && (
                <div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center"}}>
                  <div style={{width:28,height:28,border:"3px solid #ede8db",borderTopColor:"#c9a84c",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}/>
                </div>
              )}
              <img
                key={imgId}
                src={`https://picsum.photos/id/${imgId}/600/450`}
                alt="Describe this image"
                onLoad={()=>setImgOk(true)}
                onError={()=>{setImgOk(false);setImgId(randImg(imgId));}}
                style={{width:"100%",height:"100%",objectFit:"cover",opacity:imgOk?1:0,transition:"opacity 0.4s"}}
              />
            </div>
            <button onClick={newImg} style={{
              marginTop:"0.65rem",width:"100%",background:"none",
              border:"1.5px solid rgba(0,0,0,0.12)",borderRadius:5,
              padding:"0.5rem",fontFamily:"inherit",fontSize:"0.82rem",
              color:"#8a7f70",cursor:"pointer",transition:"all 0.2s"
            }}>↻ New Image</button>
          </div>

          {/* Writing col */}
          <div style={{display:"flex",flexDirection:"column"}}>
            <div style={{fontSize:"0.7rem",letterSpacing:"0.1em",textTransform:"uppercase",fontWeight:600,color:"#8a7f70",marginBottom:"0.5rem"}}>Your Task</div>
            <div style={{
              background:"#ede8db", borderLeft:`3px solid ${cfg.color}`,
              borderRadius:"0 5px 5px 0", padding:"0.8rem 1rem",
              marginBottom:"1rem", fontSize:"0.87rem", color:"#4a4540", lineHeight:1.65
            }}>{cfg.prompt}</div>

            <textarea
              value={text}
              onChange={e=>setText(e.target.value)}
              placeholder="Write your description here…"
              style={{
                flex:1, minHeight:190, padding:"1rem",
                border:"1.5px solid rgba(0,0,0,0.12)", borderRadius:5,
                fontFamily:"inherit", fontSize:"0.95rem", lineHeight:1.75,
                color:"#0a0a0f", background:"white", resize:"vertical"
              }}
            />

            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"0.5rem",marginBottom:"0.9rem"}}>
              <span style={{fontSize:"0.78rem",color: words < cfg.min ? "#c0512f" : "#4a7c6f", fontWeight:500}}>
                {words} words {words < cfg.min ? `· need ${cfg.min}+` : "✓"}
              </span>
            </div>

            <Btn variant="green" onClick={submit} disabled={words<3} style={{width:"100%",padding:"0.95rem"}}>
              ✓ Check My Writing
            </Btn>
          </div>
        </div>
      </main>
    </div>
  );

  /* ── Result screen */
  if(screen==="result" && feedback) return (
    <div style={{minHeight:"100vh",background:"#f5f0e8"}}>
      <header style={{padding:"1.1rem 2rem",borderBottom:"1px solid rgba(0,0,0,0.09)",display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"}}>
        <Btn variant="back" onClick={()=>setScreen("practice")}>← Edit</Btn>
        <Tag level={level}/>
      </header>

      <main style={{maxWidth:760,margin:"0 auto",padding:"2rem 1.5rem 4rem",animation:"fadeUp 0.4s ease"}}>
        {/* Score row */}
        <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:"2rem",gap:"1rem",flexWrap:"wrap"}}>
          <div>
            <h2 style={{fontFamily:"'Playfair Display',serif",fontSize:"2rem",fontWeight:900,lineHeight:1.1}}>Writing Feedback</h2>
            <p style={{color:"#4a7c6f",marginTop:"0.4rem",fontSize:"0.9rem",fontStyle:"italic",maxWidth:480}}>{feedback.encouragement}</p>
          </div>
          <ScoreRing score={feedback.score}/>
        </div>

        {/* Original */}
        <div style={{background:"#ede8db",borderLeft:"3px solid rgba(0,0,0,0.18)",borderRadius:"0 5px 5px 0",padding:"1rem 1.3rem",marginBottom:"2rem"}}>
          <div style={{fontSize:"0.68rem",letterSpacing:"0.1em",textTransform:"uppercase",color:"#8a7f70",fontWeight:600,marginBottom:"0.5rem"}}>Your Writing</div>
          <p style={{fontSize:"0.92rem",lineHeight:1.85,color:"#0a0a0f"}}>{text}</p>
        </div>

        {/* Cards */}
        <CorrCard icon="✎" bg="#fce4d6" fg="#c0512f" title="Spelling" badge={feedback.spellingErrors?.length||0}>
          {!feedback.spellingErrors?.length ? <NoErr label="spelling"/> : <ErrList items={feedback.spellingErrors} dot="#c0512f"/>}
        </CorrCard>

        <CorrCard icon="⚙" bg="#d6e8f5" fg="#2a6fa8" title="Grammar" badge={feedback.grammarErrors?.length||0}>
          {!feedback.grammarErrors?.length ? <NoErr label="grammar"/> : <ErrList items={feedback.grammarErrors} dot="#2a6fa8"/>}
        </CorrCard>

        <CorrCard icon="✦" bg="#d6f0e8" fg="#4a7c6f" title="Writing Style" badge={feedback.styleAdvice?.length||0}>
          {!feedback.styleAdvice?.length ? <NoErr label="style"/> : <ErrList items={feedback.styleAdvice} dot="#4a7c6f" isStyle/>}
        </CorrCard>

        <CorrCard icon="✐" bg="#f5f0d6" fg="#8a7a2a" title="Suggested Rewrite">
          <p style={{fontSize:"0.78rem",color:"#8a7f70",marginBottom:"0.75rem"}}>Here's an improved version keeping your ideas:</p>
          <div style={{
            background:"#fffdf5", border:"1.5px dashed #c9a84c",
            borderRadius:5, padding:"1rem 1.2rem",
            fontSize:"0.95rem", lineHeight:1.9, color:"#0a0a0f"
          }}>{feedback.rewrite}</div>
        </CorrCard>

        {/* Actions */}
        <div style={{display:"flex",gap:"1rem",marginTop:"1.5rem",flexWrap:"wrap"}}>
          <Btn variant="dark" onClick={()=>{setText("");setScreen("practice");}} style={{flex:1,textAlign:"center"}}>
            Try Same Image Again
          </Btn>
          <Btn variant="ghost" onClick={()=>{setText("");newImg();setScreen("practice");}} style={{flex:1,textAlign:"center"}}>
            New Image →
          </Btn>
        </div>
      </main>
    </div>
  );

  return null;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
