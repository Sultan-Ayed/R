<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WriteUp — English Writing Practice</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #0a0a0f;
    --paper: #f5f0e8;
    --cream: #ede8db;
    --gold: #c9a84c;
    --gold-light: #e8c96a;
    --sage: #4a7c6f;
    --rust: #c0512f;
    --text-muted: #6b6560;
    --border: rgba(10,10,15,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    font-family: 'DM Sans', sans-serif;
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
  }

  /* HEADER */
  header {
    padding: 2rem 4rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 900;
    letter-spacing: -0.03em;
  }
  .logo span { color: var(--gold); }

  .tagline {
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    font-weight: 500;
  }

  /* MAIN */
  main {
    max-width: 900px;
    margin: 0 auto;
    padding: 3rem 2rem 6rem;
  }

  /* SCREENS */
  .screen { display: none; animation: fadeIn 0.5s ease; }
  .screen.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(18px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* LEVEL SELECT SCREEN */
  .hero-text {
    text-align: center;
    margin-bottom: 3.5rem;
  }
  .hero-text h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.4rem, 5vw, 3.8rem);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 1rem;
  }
  .hero-text p {
    font-size: 1.05rem;
    color: var(--text-muted);
    max-width: 480px;
    margin: 0 auto;
    line-height: 1.7;
  }

  .levels-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.2rem;
    margin-bottom: 2rem;
  }

  .level-card {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    padding: 1.8rem 1.5rem;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .level-card::before {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
    background: var(--gold);
    transform: scaleX(0);
    transition: transform 0.25s ease;
  }
  .level-card:hover { border-color: var(--gold); transform: translateY(-3px); box-shadow: 0 8px 32px rgba(0,0,0,0.08); }
  .level-card:hover::before { transform: scaleX(1); }
  .level-card.selected { border-color: var(--gold); background: #fffdf5; box-shadow: 0 4px 20px rgba(201,168,76,0.2); }
  .level-card.selected::before { transform: scaleX(1); }

  .level-badge {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem;
    font-weight: 900;
    color: var(--gold);
    margin-bottom: 0.5rem;
  }
  .level-name {
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 500;
    color: var(--ink);
    margin-bottom: 0.5rem;
  }
  .level-desc {
    font-size: 0.82rem;
    color: var(--text-muted);
    line-height: 1.5;
  }

  .start-btn {
    display: block;
    width: 100%;
    max-width: 320px;
    margin: 2.5rem auto 0;
    padding: 1rem 2rem;
    background: var(--ink);
    color: var(--paper);
    border: none;
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
  }
  .start-btn:hover { background: var(--gold); color: var(--ink); }
  .start-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* PRACTICE SCREEN */
  .practice-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .back-btn {
    background: none;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem 1rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--ink);
  }
  .back-btn:hover { border-color: var(--ink); }

  .level-indicator {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--gold);
    background: #fffdf5;
    border: 1.5px solid var(--gold);
    padding: 0.3rem 0.9rem;
    border-radius: 4px;
  }

  .practice-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .image-section {
    position: relative;
  }

  .image-frame {
    width: 100%;
    aspect-ratio: 4/3;
    border-radius: 4px;
    overflow: hidden;
    border: 1.5px solid var(--border);
    background: var(--cream);
    position: relative;
  }
  .image-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.4s;
  }
  .image-loading {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--cream);
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .new-image-btn {
    margin-top: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    background: none;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem 0.9rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.2s;
    width: 100%;
    justify-content: center;
  }
  .new-image-btn:hover { border-color: var(--sage); color: var(--sage); }

  .writing-section label {
    display: block;
    font-size: 0.78rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 0.6rem;
  }

  .writing-prompt {
    font-size: 0.88rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
    line-height: 1.6;
    padding: 0.8rem;
    background: var(--cream);
    border-radius: 4px;
    border-left: 3px solid var(--gold);
  }

  textarea {
    width: 100%;
    height: 200px;
    padding: 1rem;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--ink);
    background: white;
    resize: vertical;
    transition: border-color 0.2s;
    outline: none;
  }
  textarea:focus { border-color: var(--gold); }
  textarea::placeholder { color: #b0a898; }

  .word-count {
    text-align: right;
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 0.4rem;
  }

  .correct-btn {
    display: block;
    width: 100%;
    padding: 1rem;
    background: var(--sage);
    color: white;
    border: none;
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.03em;
  }
  .correct-btn:hover { background: #3d6b5f; }
  .correct-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* CORRECTION SCREEN */
  .correction-container { max-width: 780px; margin: 0 auto; }

  .correction-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    flex-wrap: gap;
  }
  .correction-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 700;
  }

  .score-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Playfair Display', serif;
  }
  .score-number {
    font-size: 3rem;
    font-weight: 900;
    color: var(--gold);
    line-height: 1;
  }
  .score-label { font-size: 0.8rem; color: var(--text-muted); }

  .original-text-box {
    background: var(--cream);
    border-radius: 4px;
    padding: 1.2rem 1.5rem;
    margin-bottom: 2rem;
    border-left: 3px solid var(--border);
  }
  .original-text-box h3 {
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 0.6rem;
  }
  .original-text-box p {
    font-size: 0.92rem;
    line-height: 1.7;
    color: var(--ink);
  }

  .correction-sections { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem; }

  .correction-card {
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }
  .correction-card-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem 1.5rem;
    background: var(--cream);
    border-bottom: 1.5px solid var(--border);
  }
  .correction-card-icon {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 700;
    flex-shrink: 0;
  }
  .icon-spelling { background: #fce4d6; color: var(--rust); }
  .icon-grammar { background: #d6e8f5; color: #2a6fa8; }
  .icon-style { background: #d6f0e8; color: var(--sage); }
  .icon-rewrite { background: #f5f0d6; color: #8a7a2a; }

  .correction-card-title { font-weight: 600; font-size: 0.95rem; }
  .correction-card-body { padding: 1.2rem 1.5rem; }

  .error-list { list-style: none; display: flex; flex-direction: column; gap: 0.8rem; }
  .error-item {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.8rem;
    align-items: start;
    font-size: 0.88rem;
    line-height: 1.6;
  }
  .error-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 0.45rem;
    flex-shrink: 0;
  }
  .dot-spelling { background: var(--rust); }
  .dot-grammar { background: #2a6fa8; }
  .dot-style { background: var(--sage); }

  .error-wrong { color: var(--rust); text-decoration: line-through; font-weight: 500; }
  .error-right { color: var(--sage); font-weight: 600; }
  .error-note { color: var(--text-muted); }

  .rewrite-text {
    font-size: 0.95rem;
    line-height: 1.9;
    color: var(--ink);
    background: #fffdf5;
    border: 1px dashed var(--gold);
    border-radius: 4px;
    padding: 1rem 1.2rem;
  }

  .no-errors {
    font-size: 0.88rem;
    color: var(--sage);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .action-row {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }
  .try-again-btn {
    flex: 1;
    padding: 0.9rem;
    background: var(--ink);
    color: var(--paper);
    border: none;
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .try-again-btn:hover { background: var(--gold); color: var(--ink); }
  .new-topic-btn {
    flex: 1;
    padding: 0.9rem;
    background: white;
    color: var(--ink);
    border: 1.5px solid var(--border);
    border-radius: 4px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .new-topic-btn:hover { border-color: var(--ink); }

  /* Loading state */
  .loading-overlay {
    text-align: center;
    padding: 4rem 2rem;
    display: none;
  }
  .loading-overlay.active { display: block; }
  .spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    color: var(--text-muted);
  }

  @media (max-width: 650px) {
    header { padding: 1.5rem; }
    main { padding: 2rem 1rem 4rem; }
    .levels-grid { grid-template-columns: repeat(2, 1fr); }
    .practice-layout { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Write<span>Up</span></div>
  <div class="tagline">English Writing Practice</div>
</header>

<main>
  <!-- SCREEN 1: Level Selection -->
  <div id="screen-level" class="screen active">
    <div class="hero-text">
      <h1>Choose Your<br>Writing Level</h1>
      <p>Select your English proficiency level, then describe a random image to practice your writing skills.</p>
    </div>

    <div class="levels-grid">
      <div class="level-card" data-level="A1" onclick="selectLevel(this)">
        <div class="level-badge">A1</div>
        <div class="level-name">Beginner</div>
        <div class="level-desc">Simple words and basic sentences. Write 2–3 sentences.</div>
      </div>
      <div class="level-card" data-level="A2" onclick="selectLevel(this)">
        <div class="level-badge">A2</div>
        <div class="level-name">Elementary</div>
        <div class="level-desc">Short familiar sentences. Write 3–5 sentences.</div>
      </div>
      <div class="level-card" data-level="B1" onclick="selectLevel(this)">
        <div class="level-badge">B1</div>
        <div class="level-name">Intermediate</div>
        <div class="level-desc">Connected sentences on familiar topics. Write a short paragraph.</div>
      </div>
      <div class="level-card" data-level="B2" onclick="selectLevel(this)">
        <div class="level-badge">B2</div>
        <div class="level-name">Upper Intermediate</div>
        <div class="level-desc">Detailed writing with some complexity. Write 2 paragraphs.</div>
      </div>
      <div class="level-card" data-level="C1" onclick="selectLevel(this)">
        <div class="level-badge">C1</div>
        <div class="level-name">Advanced</div>
        <div class="level-desc">Clear, well-structured text. Write 2–3 detailed paragraphs.</div>
      </div>
      <div class="level-card" data-level="C2" onclick="selectLevel(this)">
        <div class="level-badge">C2</div>
        <div class="level-name">Mastery</div>
        <div class="level-desc">Fluent, spontaneous, precise writing. Write an expressive essay.</div>
      </div>
    </div>

    <button class="start-btn" id="start-btn" onclick="goToPractice()" disabled>
      Start Writing Practice →
    </button>
  </div>

  <!-- SCREEN 2: Practice -->
  <div id="screen-practice" class="screen">
    <div class="practice-header">
      <button class="back-btn" onclick="showScreen('level')">← Back</button>
      <div class="level-indicator" id="level-indicator">A1</div>
      <span style="font-size:0.85rem; color:var(--text-muted); margin-left:0.5rem;" id="level-name-small"></span>
    </div>

    <div class="practice-layout">
      <div class="image-section">
        <div class="image-frame">
          <div class="image-loading" id="img-loading">Loading image…</div>
          <img id="practice-img" src="" alt="Describe this image" style="opacity:0" onload="imgLoaded()" onerror="imgError()">
        </div>
        <button class="new-image-btn" onclick="loadNewImage()">
          ↻ New Image
        </button>
      </div>

      <div class="writing-section">
        <label>Your Response</label>
        <div class="writing-prompt" id="level-prompt"></div>
        <textarea id="user-text" placeholder="Write your description here…" oninput="updateWordCount()"></textarea>
        <div class="word-count" id="word-count">0 words</div>
        <button class="correct-btn" style="margin-top:1rem" onclick="goToCorrection()">
          ✓ Check My Writing
        </button>
      </div>
    </div>
  </div>

  <!-- SCREEN 3: Loading Correction -->
  <div id="screen-loading" class="screen">
    <div class="loading-overlay active">
      <div class="spinner"></div>
      <div class="loading-text">Analyzing your writing…</div>
    </div>
  </div>

  <!-- SCREEN 4: Correction Results -->
  <div id="screen-correction" class="screen">
    <div class="correction-container">
      <div class="correction-header">
        <h2>Writing Feedback</h2>
        <div class="score-badge">
          <div>
            <div class="score-number" id="score-display">—</div>
            <div class="score-label">/ 100</div>
          </div>
        </div>
      </div>

      <div class="original-text-box">
        <h3>Your Writing</h3>
        <p id="original-display"></p>
      </div>

      <div class="correction-sections" id="correction-sections"></div>

      <div class="action-row">
        <button class="try-again-btn" onclick="tryAgain()">Try Same Image Again</button>
        <button class="new-topic-btn" onclick="newTopic()">New Image →</button>
      </div>
    </div>
  </div>
</main>

<script>
  // ── State
  let selectedLevel = null;
  let currentImageUrl = '';
  let currentImageKeyword = '';
  let userWriting = '';

  // ── Image topics pool
  const imageTopics = [
    { keyword: 'busy city street', category: 'urban' },
    { keyword: 'mountain landscape', category: 'nature' },
    { keyword: 'family dinner table', category: 'daily life' },
    { keyword: 'colorful market', category: 'commerce' },
    { keyword: 'beach sunset', category: 'nature' },
    { keyword: 'children playing park', category: 'daily life' },
    { keyword: 'old library books', category: 'education' },
    { keyword: 'coffee shop morning', category: 'daily life' },
    { keyword: 'forest path autumn', category: 'nature' },
    { keyword: 'kitchen cooking', category: 'home' },
    { keyword: 'bicycle city', category: 'transport' },
    { keyword: 'snow mountains winter', category: 'nature' },
    { keyword: 'street food vendor', category: 'food' },
    { keyword: 'dog running field', category: 'animals' },
    { keyword: 'classroom students', category: 'education' },
    { keyword: 'harbor boats sunset', category: 'travel' },
    { keyword: 'woman reading garden', category: 'leisure' },
    { keyword: 'rainy window city', category: 'urban' },
    { keyword: 'farmers market vegetables', category: 'food' },
    { keyword: 'sports stadium crowd', category: 'sports' },
  ];

  // ── Level configs
  const levelConfig = {
    A1: { name: 'Beginner', prompt: 'Write 2–3 simple sentences about this image. What do you see?', minWords: 10, maxWords: 40 },
    A2: { name: 'Elementary', prompt: 'Write 3–5 sentences describing the image. What is happening? Where is it?', minWords: 25, maxWords: 70 },
    B1: { name: 'Intermediate', prompt: 'Write a short paragraph (5–8 sentences) describing the image and what you think is happening.', minWords: 50, maxWords: 120 },
    B2: { name: 'Upper Intermediate', prompt: 'Write 2 paragraphs: one describing the scene, and one expressing your thoughts or feelings about it.', minWords: 80, maxWords: 200 },
    C1: { name: 'Advanced', prompt: 'Write 2–3 detailed paragraphs. Describe the scene vividly, analyze its mood, and reflect on what story might be behind it.', minWords: 120, maxWords: 350 },
    C2: { name: 'Mastery', prompt: 'Write an expressive, nuanced piece about this image. Use sophisticated vocabulary, varied sentence structures, and explore the deeper meaning or emotion of the scene.', minWords: 180, maxWords: 500 },
  };

  // ── UI helpers
  function showScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
  }

  function selectLevel(card) {
    document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedLevel = card.dataset.level;
    document.getElementById('start-btn').disabled = false;
  }

  function goToPractice() {
    if (!selectedLevel) return;
    const cfg = levelConfig[selectedLevel];
    document.getElementById('level-indicator').textContent = selectedLevel;
    document.getElementById('level-name-small').textContent = cfg.name;
    document.getElementById('level-prompt').textContent = cfg.prompt;
    document.getElementById('user-text').value = '';
    updateWordCount();
    showScreen('practice');
    loadNewImage();
  }

  // ── Image loading via Picsum (reliable random images)
  const imagePool = [
    'https://picsum.photos/seed/city1/600/450',
    'https://picsum.photos/seed/nature2/600/450',
    'https://picsum.photos/seed/people3/600/450',
    'https://picsum.photos/seed/food4/600/450',
    'https://picsum.photos/seed/travel5/600/450',
    'https://picsum.photos/seed/market6/600/450',
    'https://picsum.photos/seed/park7/600/450',
    'https://picsum.photos/seed/street8/600/450',
    'https://picsum.photos/seed/beach9/600/450',
    'https://picsum.photos/seed/library10/600/450',
    'https://picsum.photos/seed/coffee11/600/450',
    'https://picsum.photos/seed/forest12/600/450',
    'https://picsum.photos/seed/kitchen13/600/450',
    'https://picsum.photos/seed/bike14/600/450',
    'https://picsum.photos/seed/snow15/600/450',
    'https://picsum.photos/seed/dog16/600/450',
    'https://picsum.photos/seed/class17/600/450',
    'https://picsum.photos/seed/harbor18/600/450',
    'https://picsum.photos/seed/garden19/600/450',
    'https://picsum.photos/seed/rain20/600/450',
  ];

  let lastImageIndex = -1;

  function loadNewImage() {
    const img = document.getElementById('practice-img');
    const loading = document.getElementById('img-loading');
    img.style.opacity = '0';
    loading.style.display = 'flex';

    let idx;
    do { idx = Math.floor(Math.random() * imagePool.length); } while (idx === lastImageIndex);
    lastImageIndex = idx;

    // Use a random picsum photo
    const randomId = Math.floor(Math.random() * 900) + 100;
    currentImageUrl = `https://picsum.photos/id/${randomId}/600/450`;
    currentImageKeyword = imageTopics[idx % imageTopics.length].keyword;

    img.src = currentImageUrl;
  }

  function imgLoaded() {
    document.getElementById('practice-img').style.opacity = '1';
    document.getElementById('img-loading').style.display = 'none';
  }

  function imgError() {
    // fallback to a working picsum URL
    document.getElementById('practice-img').src = 'https://picsum.photos/600/450?random=' + Date.now();
  }

  function updateWordCount() {
    const text = document.getElementById('user-text').value.trim();
    const words = text ? text.split(/\s+/).length : 0;
    document.getElementById('word-count').textContent = words + ' word' + (words !== 1 ? 's' : '');
  }

  // ── Correction via Claude API
  async function goToCorrection() {
    const text = document.getElementById('user-text').value.trim();
    if (!text || text.split(/\s+/).length < 3) {
      alert('Please write at least a few words before checking!');
      return;
    }
    userWriting = text;
    showScreen('loading');

    try {
      const feedback = await getCorrectionFromClaude(text, selectedLevel);
      displayCorrection(feedback);
      showScreen('correction');
    } catch (e) {
      console.error(e);
      alert('Something went wrong. Please try again.');
      showScreen('practice');
    }
  }

  async function getCorrectionFromClaude(text, level) {
    const levelDescriptions = {
      A1: 'beginner (A1) – very basic English, simple vocabulary',
      A2: 'elementary (A2) – basic sentences and familiar topics',
      B1: 'intermediate (B1) – can handle familiar topics with some errors',
      B2: 'upper-intermediate (B2) – fairly complex writing expected',
      C1: 'advanced (C1) – sophisticated vocabulary and complex structures expected',
      C2: 'mastery (C2) – near-native fluency expected',
    };

    const systemPrompt = `You are an expert English writing teacher. You provide detailed, educational, and encouraging feedback on student writing. Always respond with a valid JSON object only — no markdown, no extra text.`;

    const userPrompt = `A student at level ${levelDescriptions[level]} wrote the following English text to describe an image:

"${text}"

Please analyze their writing and return a JSON object with EXACTLY this structure:
{
  "score": <number 0-100>,
  "spellingErrors": [
    { "wrong": "...", "correct": "...", "explanation": "..." }
  ],
  "grammarErrors": [
    { "wrong": "...", "correct": "...", "explanation": "..." }
  ],
  "styleAdvice": [
    { "issue": "...", "suggestion": "..." }
  ],
  "rewrite": "A corrected and improved version of the full text at their level",
  "encouragement": "A short encouraging message (1-2 sentences)"
}

Rules:
- If there are no spelling errors, spellingErrors should be an empty array []
- If there are no grammar errors, grammarErrors should be an empty array []
- If style is already good, styleAdvice should be an empty array []
- The rewrite should be natural and appropriate for the student's level
- Score: 90-100 = excellent, 75-89 = good, 60-74 = fair, below 60 = needs work
- Be encouraging and educational, not discouraging`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: 'user', content: userPrompt }]
      })
    });

    const data = await response.json();
    const rawText = data.content.map(b => b.text || '').join('');
    const clean = rawText.replace(/```json|```/g, '').trim();
    return JSON.parse(clean);
  }

  function displayCorrection(feedback) {
    document.getElementById('original-display').textContent = userWriting;
    document.getElementById('score-display').textContent = feedback.score;

    const scoreEl = document.getElementById('score-display');
    if (feedback.score >= 85) scoreEl.style.color = 'var(--sage)';
    else if (feedback.score >= 65) scoreEl.style.color = 'var(--gold)';
    else scoreEl.style.color = 'var(--rust)';

    const sections = document.getElementById('correction-sections');
    sections.innerHTML = '';

    // Spelling
    const spellingCard = buildCorrectionCard(
      '✎', 'icon-spelling', 'Spelling',
      feedback.spellingErrors,
      'spelling',
      feedback.encouragement
    );
    sections.appendChild(spellingCard);

    // Grammar
    const grammarCard = buildCorrectionCard(
      '⚙', 'icon-grammar', 'Grammar',
      feedback.grammarErrors,
      'grammar',
      null
    );
    sections.appendChild(grammarCard);

    // Style
    const styleCard = buildStyleCard(feedback.styleAdvice);
    sections.appendChild(styleCard);

    // Rewrite
    const rewriteCard = buildRewriteCard(feedback.rewrite);
    sections.appendChild(rewriteCard);
  }

  function buildCorrectionCard(icon, iconClass, title, errors, type, encouragement) {
    const card = document.createElement('div');
    card.className = 'correction-card';
    const dotClass = `dot-${type}`;

    let body = '';
    if (!errors || errors.length === 0) {
      body = `<div class="no-errors">✓ No ${type} errors found — great job!</div>`;
    } else {
      body = '<ul class="error-list">' + errors.map(e => `
        <li class="error-item">
          <span class="error-dot ${dotClass}"></span>
          <div>
            <span class="error-wrong">${e.wrong || e.issue || ''}</span>
            ${e.correct ? `→ <span class="error-right">${e.correct}</span>` : ''}
            <br><span class="error-note">${e.explanation || e.suggestion || ''}</span>
          </div>
        </li>
      `).join('') + '</ul>';
    }

    if (encouragement) {
      body += `<p style="margin-top:1rem;font-size:0.85rem;color:var(--sage);font-style:italic;">${encouragement}</p>`;
    }

    card.innerHTML = `
      <div class="correction-card-header">
        <div class="correction-card-icon ${iconClass}">${icon}</div>
        <div class="correction-card-title">${title}</div>
        ${errors && errors.length > 0 ? `<span style="margin-left:auto;background:#fce4d6;color:var(--rust);font-size:0.75rem;font-weight:600;padding:0.2rem 0.6rem;border-radius:20px;">${errors.length} issue${errors.length>1?'s':''}</span>` : ''}
      </div>
      <div class="correction-card-body">${body}</div>
    `;
    return card;
  }

  function buildStyleCard(styleAdvice) {
    const card = document.createElement('div');
    card.className = 'correction-card';
    let body = '';
    if (!styleAdvice || styleAdvice.length === 0) {
      body = '<div class="no-errors">✓ Your writing style is appropriate for your level!</div>';
    } else {
      body = '<ul class="error-list">' + styleAdvice.map(s => `
        <li class="error-item">
          <span class="error-dot dot-style"></span>
          <div>
            <span style="font-weight:500;">${s.issue}</span><br>
            <span class="error-note">${s.suggestion}</span>
          </div>
        </li>
      `).join('') + '</ul>';
    }
    card.innerHTML = `
      <div class="correction-card-header">
        <div class="correction-card-icon icon-style">✦</div>
        <div class="correction-card-title">Writing Style</div>
        ${styleAdvice && styleAdvice.length > 0 ? `<span style="margin-left:auto;background:#d6f0e8;color:var(--sage);font-size:0.75rem;font-weight:600;padding:0.2rem 0.6rem;border-radius:20px;">${styleAdvice.length} tip${styleAdvice.length>1?'s':''}</span>` : ''}
      </div>
      <div class="correction-card-body">${body}</div>
    `;
    return card;
  }

  function buildRewriteCard(rewrite) {
    const card = document.createElement('div');
    card.className = 'correction-card';
    card.innerHTML = `
      <div class="correction-card-header">
        <div class="correction-card-icon icon-rewrite">✐</div>
        <div class="correction-card-title">Suggested Rewrite</div>
      </div>
      <div class="correction-card-body">
        <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.8rem;">Here's how your writing could be improved while keeping your ideas:</p>
        <div class="rewrite-text">${rewrite}</div>
      </div>
    `;
    return card;
  }

  function tryAgain() {
    document.getElementById('user-text').value = '';
    updateWordCount();
    showScreen('practice');
  }

  function newTopic() {
    document.getElementById('user-text').value = '';
    updateWordCount();
    loadNewImage();
    showScreen('practice');
  }
</script>
</body>
</html>
